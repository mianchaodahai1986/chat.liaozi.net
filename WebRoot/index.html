<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>环信测试demo</title>
    <script src="sdk/dist/strophe-1.2.8.min.js"></script>
    <script src="webrtc/dist/adapter.js"></script>
	<script src="demo/javascript/dist/webim.config.js"></script>
    <script src="sdk/dist/websdk-1.4.12.js"></script>
    <script src="webrtc/dist/webrtc-1.4.12.js"></script>
    <script src="jquery.js"></script>
    <!-- fix: ie8 upload -->
	<style>
 
#pic_list li
{
width:30px;
height:30px;
margin:3px;
display:inline-block;
}

#pic_list{
	width: 334px;
	position: relative;
	top:-97px;
	left:389px; 
	border: 1px solid #ddd;
	z-index: 100;
	background: #fff;
} 

</style>
</head>
<body>
 <form class="form-signin" id="form" name="jz-form-signin">
      <input name="myusername" id="userName" value="" type="text" class="form-control" placeholder="账户：" required>
      <span class="jz-name-error"></span>
      <input name="mypassword" id="passWord" value="" type="password" class="form-control" placeholder="密码：" required>
      <input id="submit" class="btn btn-lg btn-primary btn-block"  onclick="setUser();" type="button" value="登录"></input>
</form>
<div style="display:none;" id="disDiv">
	当前用户为:<input id="inputValue" value="" readonly="true" style="border:0px;"/></br>
	<span id="liS">li</span><input type="radio"  name="friendId" value="li" id="li">
	<span id="lisiS">lisi</span><input type ="radio" name="friendId" value="lisi" id="lisi">
	<span id="jinsankejiS">jinsankeji</span><input type ="radio" name="friendId" value="jinsankeji" id="jinsankeji">
	<span id="zzf2S">zzf2</span><input type ="radio" name="friendId" value="zzf2" id="zzf2">
	<span id="blueskyzh2S">blueskyzh2</span><input type ="radio" name="friendId" value="blueskyzh2" id="blueskyzh2">
	<input type="button" value="退出" id="logout"/>
	</input>
	<div id="content" name="content" style="width: 90%; height: 300px; margin-top:5px; border:1px solid #000; overflow:scroll; width:1200px; height:400px;" disabled="disabled">
	
	</div>
	<!-- <input type="textarea" id="msg" /> -->
	<p contenteditable="true" style="height: 100px; border: 1px solid gray;" id="msg" class="mag"></p>
	
	
	<button id="privateText" onclick="sendPrivateText();">发送消息</button>
	<div>
        <br>
        	图片: <input type="file" id="image">
        <button id="privateImg" onclick="sendImage()">发送图片</button>
    </div>
    <img class="webim-msg-img" id="imgId" src="" data-reactid=".6.2.1.1.$0">
        表情: <button id="privateImg" onclick="sendLook()">发送表情</button>
    <div id="pic_list" class="webim-send-wrapper" data-reactid=".0.0.3.2:$lisi.4" style="display:none;">
    	<ul class="" data-reactid=".0.0.3.2:$lisi.4.1" id="ulClass">
    	<li key="[):]" class="webim-emoji-item"><img src="demo/images/faces/ee_1.png"></li>
    	<li key="[:D]" class="webim-emoji-item"><img src="demo/images/faces/ee_2.png"></li>
    	<li key="[;)]" class="webim-emoji-item"><img src="demo/images/faces/ee_3.png"></li>
    	<li key="[:-o]" class="webim-emoji-item"><img src="demo/images/faces/ee_4.png"></li>
    	<li key="[:p]" class="webim-emoji-item"><img src="demo/images/faces/ee_5.png"></li>
    	<li key="[(H)]" class="webim-emoji-item"><img src="demo/images/faces/ee_6.png"></li>
    	<li key="[:@]" class="webim-emoji-item"><img src="demo/images/faces/ee_7.png"></li>
    	<li key="[:s]" class="webim-emoji-item"><img src="demo/images/faces/ee_8.png"></li>
    	<li key="[:$]" class="webim-emoji-item"><img src="demo/images/faces/ee_9.png"></li>
    	<li key="[:(]" class="webim-emoji-item"><img src="demo/images/faces/ee_10.png"></li>
    	<li key="[:'(]" class="webim-emoji-item"><img src="demo/images/faces/ee_11.png"></li>
    	<li key="[:|]" class="webim-emoji-item"><img src="demo/images/faces/ee_18.png"></li>
    	<li key="[(a)]" class="webim-emoji-item"><img src="demo/images/faces/ee_13.png"></li>
    	<li key="[8o|]" class="webim-emoji-item"><img src="demo/images/faces/ee_14.png"></li>
    	<li key="[8-|]" class="webim-emoji-item"><img src="demo/images/faces/ee_15.png"></li>
    	<li key="[+o(]" class="webim-emoji-item"><img src="demo/images/faces/ee_16.png"></li>
    	<li key="[<o)]" class="webim-emoji-item"><img src="demo/images/faces/ee_12.png"></li>
    	<li key="[|-)]" class="webim-emoji-item"><img src="demo/images/faces/ee_17.png"></li>
    	<li key="[*-)]" class="webim-emoji-item"><img src="demo/images/faces/ee_19.png"></li>
    	<li key="[:-#]" class="webim-emoji-item"><img src="demo/images/faces/ee_20.png"></li>
    	<li key="[:-*]" class="webim-emoji-item"><img src="demo/images/faces/ee_22.png"></li>
    	<li key="[^o)]" class="webim-emoji-item"><img src="demo/images/faces/ee_21.png"></li>
    	<li key="[8-)]" class="webim-emoji-item"><img src="demo/images/faces/ee_23.png"></li>
    	<li key="[(|)]" class="webim-emoji-item"><img src="demo/images/faces/ee_24.png"></li>
    	<li key="[(u)]" class="webim-emoji-item"><img src="demo/images/faces/ee_25.png"></li>
    	<li key="[(S)]" class="webim-emoji-item"><img src="demo/images/faces/ee_26.png"></li>
    	<li key="[(*)]" class="webim-emoji-item"><img src="demo/images/faces/ee_27.png"></li>
    	<li key="[(#)]" class="webim-emoji-item"><img src="demo/images/faces/ee_28.png"></li>
    	<li key="[(R)]" class="webim-emoji-item"><img src="demo/images/faces/ee_29.png"></li>
    	<li key="[({)]" class="webim-emoji-item"><img src="demo/images/faces/ee_30.png"></li>
    	<li key="[(})]" class="webim-emoji-item"><img src="demo/images/faces/ee_31.png"></li>
    	<li key="[(k)]" class="webim-emoji-item"><img src="demo/images/faces/ee_32.png"></li>
    	<li key="[(F)]" class="webim-emoji-item"><img src="demo/images/faces/ee_33.png"></li>
    	<li key="[(W)]" class="webim-emoji-item"><img src="demo/images/faces/ee_34.png"></li>
    	<li key="[(D)]" class="webim-emoji-item"><img src="demo/images/faces/ee_35.png"></li></ul>
    </div>
</div>
<script>
    /**
     * Created by clock on 16-11-25.
     */
    var conn = {};
    conn = new WebIM.connection({
        isMultiLoginSessions: WebIM.config.isMultiLoginSessions,
        https: typeof WebIM.config.https === 'boolean' ? WebIM.config.https : location.protocol === 'https:',
        url: WebIM.config.xmppURL,
        isAutoLogin: true,
        heartBeatWait: WebIM.config.heartBeatWait,
        autoReconnectNumMax: WebIM.config.autoReconnectNumMax,
        autoReconnectInterval: WebIM.config.autoReconnectInterval
    });

    


    // listern，添加回调函数
    conn.listen({
        onOpened: function (message) {          //连接成功回调，连接成功后才可以发送消息
            //如果isAutoLogin设置为false，那么必须手动设置上线，否则无法收消息
            // 手动上线指的是调用conn.setPresence(); 在本例中，conn初始化时已将isAutoLogin设置为true
            // 所以无需调用conn.setPresence();
            console.log("%c [opened] 连接已成功建立", "color: green")
        },
        onTextMessage: function (message) {
            // 在此接收和处理消息，根据message.type区分消息来源，私聊或群组或聊天室
            console.log(message);
            var cont = $("#content").html()+"<br/>";
            var br = document.createElement("br");
            var div = document.getElementById("content");
            div.appendChild(br);
            var time = new Date();
        	   // 程序计时的月从0开始取值后+1
        	   var m = time.getMonth() + 1;
        	   var t = time.getFullYear() + "-" + m + "-"
        	     + time.getDate() + " " + time.getHours() + ":"
        	     + time.getMinutes() + ":" + time.getSeconds();
            $("#content").html(cont+message.data+"&nbsp;&nbsp;&nbsp;消息来自:"+message.from+"&nbsp;&nbsp;&nbsp;"+t);
            $('#content').scrollTop( $('#content')[0].scrollHeight );
            /* var siz = $("#ulClass li").length;
            var flag = true;
            var br = document.createElement("br");
            var div = document.getElementById("content");
            var time = new Date();
        	   // 程序计时的月从0开始取值后+1
        	   var m = time.getMonth() + 1;
        	   var t = time.getFullYear() + "-" + m + "-"
        	     + time.getDate() + " " + time.getHours() + ":"
        	     + time.getMinutes() + ":" + time.getSeconds();
            $("#ulClass li").each(function(){
	            if(message.data==$(this).attr("key")){
	            	var imgpath = $(this).find('img').attr("src");
	            	//$("#content").text(cont+imgpath+"  消息来自:"+message.from);
	            	//<img src="demo/images/faces/ee_2.png">
	            	
				　　　　//添加 img
				　　　　var img = document.createElement("img");
				 	 var sp = document.createElement("span");
				 	 //console.log(sp);
			 		sp.innerHTML = "&nbsp;&nbsp;&nbsp;消息来自:"+message.from+"&nbsp;&nbsp;&nbsp;"+t;
			　　　　  img.src = imgpath;
				　　　div.appendChild(img);
				    div.appendChild(sp);
				     div.appendChild(br);
	            	flag = false;
	            	return;
	            }
            	
            })
            if(flag){
            	$("#content").html(cont+message.data+"&nbsp;&nbsp;&nbsp;消息来自:"+message.from+"&nbsp;&nbsp;&nbsp;"+t);
            	div.appendChild(br);
            } */
            /* console.log(message.type);
            console.log('Text'); */
        },  //收到文本消息
        
        onEmotionMessage: function (message) {
            // 当为WebIM添加了Emoji属性后，若发送的消息含WebIM.Emoji里特定的字符串，connection就会自动将
            // 这些字符串和其它文字按顺序组合成一个数组，每一个数组元素的结构为{type: 'emoji(或者txt)', data:''}
            // 当type='emoji'时，data表示表情图像的路径，当type='txt'时，data表示文本消息
            console.log('Emoji');
            var data = message.data;
            for (var i = 0, l = data.length; i < l; i++) {
                console.log(data[i]);
            }
        },   //收到表情消息
        onPictureMessage: function (message) {
            console.log('Picture');

            var options = {url: message.url};
            options.onFileDownloadComplete = function () {
                // 图片下载成功
                console.log('Image download complete!');
            };
            options.onFileDownloadError = function () {
                // 图片下载失败
                console.log('Image download failed!');
            };
            WebIM.utils.download.call(conn, options);
            
            var br1 = document.createElement("br");
            var br2 = document.createElement("br");
            var div = document.getElementById("content");
            var img = document.createElement("img");
            img.src = message.url;
            var sp = document.createElement("span");
            var time = new Date();
        	   // 程序计时的月从0开始取值后+1
        	   var m = time.getMonth() + 1;
        	   var t = time.getFullYear() + "-" + m + "-"
        	     + time.getDate() + " " + time.getHours() + ":"
        	     + time.getMinutes() + ":" + time.getSeconds();
		 	 //console.log(sp);
	 		sp.innerHTML = "&nbsp;&nbsp;&nbsp;消息来自:"+message.from+"&nbsp;&nbsp;&nbsp"+t;
	 		div.appendChild(br2);
            div.appendChild(img);
            div.appendChild(sp);
		     div.appendChild(br1);
		     $('#content').scrollTop( $('#content')[0].scrollHeight );
            //<img class="webim-msg-img" id="imgId" src="" data-reactid=".6.2.1.1.$0">
            //$("#imgId").attr("src",message.url);
            //document.getElementById("content").innerHTML='<img class="webim-msg-img" id="imgId" src="'+message.url+'" data-reactid=".6.2.1.1.$0">'
            /* var txt=document.getElementById("content")
            var o=document.createElement("IMG");
            o.src=message.url;
            txt.appendChild(o); */

        }, //收到图片消息
        onCmdMessage: function (message) {
        	 var cont = $("#content").text()+"\r\n";
             $("#content").text(cont+message.data);
            console.log('CMD');
        },     //收到命令消息
        onAudioMessage: function (message) {
            console.log("Audio");
        },   //收到音频消息
        onLocationMessage: function (message) {
            console.log("Location");
        },//收到位置消息
        onFileMessage: function (message) {
            console.log("File");
        },    //收到文件消息
        onVideoMessage: function (message) {
            var node = document.getElementById('privateVideo');
            var option = {
                url: message.url,
                headers: {
                    'Accept': 'audio/mp4'
                },
                onFileDownloadComplete: function (response) {
                    var objectURL = WebIM.utils.parseDownloadResponse.call(conn, response);
                    node.src = objectURL;
                },
                onFileDownloadError: function () {
                    console.log('File down load error.')
                }
            };
            WebIM.utils.download.call(conn, option);
        },   //收到视频消息
        onPresence: function (message) {
            switch (message.type) {
                case 'subscribe':                           // 对方请求添加好友
                    // 同意对方添加好友
                    document.getElementById('agreeFriends').onclick = function (message) {
                        conn.subscribed({
                            to: 'asdfghj',
                            message: "[resp:true]"
                        });
                    };
                    // 拒绝对方添加好友
                    document.getElementById('rejectFriends').onclick = function (message) {
                        conn.unsubscribed({
                            to: message.from,
                            message: "rejectAddFriend"                  // 拒绝添加好友回复信息
                        });
                    };

                    break;
                case 'subscribed':                          // 对方同意添加好友，已方同意添加好友
                    break;
                case 'unsubscribe':                         // 对方删除好友
                    break;
                case 'unsubscribed':                        // 被拒绝添加好友，或被对方删除好友成功
                    break;
                case 'memberJoinPublicGroupSuccess':                 // 成功加入聊天室
                    console.log('join chat room success');
                    break;
                case 'joinChatRoomFaild':                   // 加入聊天室失败
                    console.log('join chat room faild');
                    break;
                case 'joinPublicGroupSuccess':              // 意义待查
                    console.log('join public group success', message.from);
                    break;
                case 'createGroupACK':
                    conn.createGroupAsync({
                        from: message.from,
                        success: function (option) {
                            console.log('Create Group Succeed');
                        }
                    });
                    break;
            }
        },       //收到联系人订阅请求（加好友）、处理群组、聊天室被踢解散等消息
        onRoster: function (message) {
            console.log('Roster');
        },         //处理好友申请
        onInviteMessage: function (message) {
            console.log('Invite');
        },  //处理群组邀请
        onOnline: function () {
            console.log('onLine');
        },                  //本机网络连接成功
        onOffline: function () {
            console.log('offline');
        },                 //本机网络掉线
        onError: function (message) {
            console.log('Error');
            console.log(message);
            if (message && message.type == 1) {
                console.warn('连接建立失败！请确认您的登录账号是否和appKey匹配。')
            }
        },           //失败回调
        onBlacklistUpdate: function (list) {
            // 查询黑名单，将好友拉黑，将好友从黑名单移除都会回调这个函数，list则是黑名单现有的所有好友信息
            console.log(list);
        }     // 黑名单变动
    });
    // 初始化WebRTC Call
    var rtcCall = null
    if (WebIM.WebRTC) {
        rtcCall = new WebIM.WebRTC.Call({
            connection: conn,

            mediaStreamConstaints: {
                audio: true,
                video: true
            },

            listener: {
                onAcceptCall: function (from, options) {
                    console.log('onAcceptCall::', 'from: ', from, 'options: ', options);
                },
                onGotRemoteStream: function (stream, streamType) {
                    console.log('onGotRemoteStream::', 'stream: ', stream, 'streamType: ', streamType);
                    var video = document.getElementById('video');
                    video.srcObject = stream;
                },
                onGotLocalStream: function (stream, streamType) {
                    console.log('onGotLocalStream::', 'stream:', stream, 'streamType: ', streamType);
                    var video = document.getElementById('localVideo');
                    video.srcObject = stream;
                },
                onRinging: function (caller) {
                    console.log('onRinging::', 'caller:', caller);
                },
                onTermCall: function (reason) {
                    console.log('onTermCall::');
                    console.log('reason:', reason);
                },
                onIceConnectionStateChange: function (iceState) {
                    console.log('onIceConnectionStateChange::', 'iceState:', iceState);
                },
                onError: function (e) {
                    console.log(e);
                }
            }
        });
    } else {
        console.warn('不能进行视频通话！您的浏览器不支持webrtc或者协议不是https。')
    }
</script>
<script>
    /**
     * Created by clock on 16-11-30.
     */
        // open，登录
      var user1;
      var pwd1;
      var cookie = {
      	    set:function(key,val,time){//设置cookie方法
      	        var date=new Date(); //获取当前时间
      	        var expiresDays=time;  //将date设置为n天以后的时间
      	        date.setTime(date.getTime()+expiresDays*24*3600*1000); //格式化为cookie识别的时间
      	        document.cookie=key + "=" + val +";expires="+date.toGMTString();  //设置cookie
      	    },
      	    get:function(key){//获取cookie方法
      	        /*获取cookie参数*/
      	        var getCookie = document.cookie.replace(/[ ]/g,"");  //获取cookie，并且将获得的cookie格式化，去掉空格字符
      	        var arrCookie = getCookie.split(";")  //将获得的cookie以"分号"为标识 将cookie保存到arrCookie的数组中
      	        var tips;  //声明变量tips
      	        for(var i=0;i<arrCookie.length;i++){   //使用for循环查找cookie中的tips变量
      	            var arr=arrCookie[i].split("=");   //将单条cookie用"等号"为标识，将单条cookie保存为arr数组
      	            if(key==arr[0]){  //匹配变量名称，其中arr[0]是指的cookie名称，如果该条变量为tips则执行判断语句中的赋值操作
      	                tips=arr[1];   //将cookie的值赋给变量tips
      	                break;   //终止for循环遍历
      	            }
      	        }
      	        return tips;
      	    }/* ,
      	      delete:function(key){ //删除cookie方法
      	         var date = new Date(); //获取当前时间
      	         date.setTime(date.getTime()-10000); //将date设置为过去的时间
      	         document.cookie = key + "=v; expires =" +date.toGMTString();//设置cookie
      	        } */
      	    }
      function setUser(){
    	/* alert($("#userName").val());
    	alert($("#passWord").val()); */
    	var user = $("#userName").val();
    	var pwd = $("#passWord").val();
        options = {
                apiUrl: WebIM.config.apiURL,
                user:''+user+'',
                pwd:''+pwd+'',
                appKey: WebIM.config.appkey
            };
            conn.open(options);
            user1 = user;
            pwd1 = pwd;
            document.cookie="popped=yes"
            cookie.set("user1",user1,1);//设置为1天过期
            cookie.set("pwd1",pwd1,1);//设置为1天过期
            $("#disDiv").show();
            $("#inputValue").val(user1);
            document.getElementById('form').style.display='none';
            document.getElementById(user1).style.display='none';
            document.getElementById(user1+'S').style.display='none';
    }


    var register = function () {
        var option = {
            username: 'bossffffsasdfasgrewgeg',
            password: 'a',
            nickname: 'clock',
            appKey: WebIM.config.appkey,
            success: function () {
                console.log('regist success!');
            },
            error: function () {
                console.log('regist error');
            },
            apiUrl: WebIM.config.apiURL
        };
        conn.signup(option);
    };

    // 私聊发送文本消息，发送表情同发送文本消息，只是会在对方客户端将表情文本进行解析成图片
    function sendPrivateText() {
    	
    	var cont = $("#content").html()+"<br/>";
        var br = document.createElement("br");
        var div = document.getElementById("content");
        var flag = true;
        var id = conn.getUniqueId();
        var msg = new WebIM.message('txt', id);
        var frendId = $("input[type='radio']:checked").val();
        if(frendId==undefined){
        	alert("请选择发送对象");
        	return;
        	}
        msg.set({
            msg: $("#msg").html(),                       // 消息内容
            to: frendId,                          // 接收消息对象
            roomType: false,
            success: function (id, serverMsgId) {
                console.log("send private text Success");
            }
        });
        msg.body.chatType = 'singleChat';
        conn.send(msg.body);
        
        $("#ulClass li").each(function(){
            if($("#msg").val()==$(this).attr("key")){
            	var imgpath = $(this).find('img').attr("src");
            	//$("#content").text(cont+imgpath+"  消息来自:"+message.from);
            	//<img src="demo/images/faces/ee_2.png">
            	
			　　　　//添加 img
			　　　　var img = document.createElement("img");
			 	 var sp = document.createElement("span");
			 	 //console.log(sp);
		 		
		 		var time = new Date();
        	   // 程序计时的月从0开始取值后+1
        	   var m = time.getMonth() + 1;
        	   var t = time.getFullYear() + "-" + m + "-"
        	     + time.getDate() + " " + time.getHours() + ":"
        	     + time.getMinutes() + ":" + time.getSeconds();
        	sp.innerHTML = "&nbsp;&nbsp;&nbsp;我&nbsp;"+t;
		　　　　  img.src = imgpath;
			　　　div.appendChild(img);
			    div.appendChild(sp);
			     div.appendChild(br);
            	flag = false;
            	$("#msg").val("");
            	return;
            }
        	
        })
        if(flag){
        	var time = new Date();
        	   // 程序计时的月从0开始取值后+1
        	   var m = time.getMonth() + 1;
        	   var t = time.getFullYear() + "-" + m + "-"
        	     + time.getDate() + " " + time.getHours() + ":"
        	     + time.getMinutes() + ":" + time.getSeconds();
        $("#content").html(cont+$("#msg").html()+"&nbsp;&nbsp;&nbsp;我&nbsp;"+t);
        $("#msg").html("");
        div.appendChild(br);
        }
        $('#content').scrollTop( $('#content')[0].scrollHeight );
    	return;
    }

    // 私聊发送命令消息
    var sendPrivateCmd = function () {
        var id = conn.getUniqueId();
        var msg = new WebIM.message('cmd', id);
        msg.set({
            msg: 'ls',
            to: 'asdfghj',
            roomType: false,
            success: function (id, serverMsgId) {
                console.log('CMD Success');
            }
        });
        msg.body.chatType = 'singleChat';
        conn.send(msg.body);
    };

    // 私聊发送图片消息
    function sendImage() {
    	var frendId = $("input[type='radio']:checked").val();
    	if(frendId==undefined){
        	alert("请选择发送对象");
        	return;
        	}
        var id = conn.getUniqueId();
        var msg = new WebIM.message('img', id);
        var input = document.getElementById('image');               // 选择图片的input
        var file = WebIM.utils.getFileUrl(input);                   // 将图片转化为二进制文件
        var allowType = {
            'jpg': true,
            'gif': true,
            'png': true,
            'bmp': true
        };

        var option = {
            apiUrl: WebIM.config.apiURL,
            file: file,
            to: frendId,
            roomType: false,
            chatType: 'singleChat',
            onFileUploadError: function () {
                console.log('onFileUploadError');
            },
            onFileUploadComplete: function () {
                console.log('onFileUploadComplete');
            },
            success: function () {
                console.log('Success');
            },
        };
        // for ie8
        try {
            if (!file.filetype.toLowerCase() in allowType) {
                console.log('file type error')
                return
            }
        } catch (e) {
            option.flashUpload = WebIM.flashUpload
        }
        msg.set(option);
        conn.send(msg.body);
        
        var br1 = document.createElement("br");
        var div = document.getElementById("content");
        var img = document.createElement("img");
        img.src = file.url;
        var sp = document.createElement("span");
        var time = new Date();
    	   // 程序计时的月从0开始取值后+1
   	   var m = time.getMonth() + 1;
   	   var t = time.getFullYear() + "-" + m + "-"
   	     + time.getDate() + " " + time.getHours() + ":"
   	     + time.getMinutes() + ":" + time.getSeconds();
	 	 //console.log(sp);
 		sp.innerHTML = "&nbsp;&nbsp;&nbsp;我&nbsp;"+t;
        div.appendChild(img);
        div.appendChild(sp);
	     div.appendChild(br1);
	     $('#content').scrollTop( $('#content')[0].scrollHeight );
    };

    // 获取好友列表
    var getRoasters = function () {
        var option = {
            success: function (roster) {
                // roster是所有好友，格式为：
                /*
                 [
                 {
                 jid:"easemob#chatdemoui_test1@easemob.com",
                 name:"test1",
                 subscription: "both"
                 // subscription的值的集合是{both, to, from, none},
                 // both表示互相在对方的好友列表中，
                 // to 和 from意义待定
                 // 如果添加对方为好友被拒绝则为none
                 }
                 ]
                 */
                for (var o in roster) {
                    console.log("jid: ", roster[o].jid);
                    console.log("name: ", roster[o].name);
                    console.log("subscription: ", roster[o].subscription);
                }
            }
        };
        conn.getRoster(option);
    };

    // 添加好友
    var addFriends = function () {
        conn.subscribe({
            to: "asdfghj",
            message: "Hello World!"                   // Demo里面接收方没有展现出来这个message，在status字段里面
        });
    };

    // 删除好友
    var removeFriends = function () {
        conn.removeRoster({
            to: 'asdfghj',
            success: function () {
                conn.unsubscribed({
                    to: 'asdfghj'
                });
            },
            error: function () {
            }
        });
    };

    // 拉黑好友，对方好友列表依然可以看到已方，但无法向已方发送消息
    // list的结构为{username_1: {}, username_2: {}...}，拉黑好友需要将拉黑后的黑名单里的好友信息全部传入，
    // 如黑名单此时已有A，B两位好友，现想将C也拉进黑名单，正确的操作是同时将ABC的信息都传入接口中。
    /*
     var list = {
     username_1:{
     jid: 'appKey_'+username_1+'@easemob.com',
     name: username_1,
     subscription: 'both',
     order: 2
     },
     username_2:{
     jid: 'appKey_'+username_2+'@easemob.com',
     name: username_2,
     subscription: 'both',
     order: 3,
     type: 'jid'
     },
     username_3:{
     jid: 'appKey_'+username_3+'@easemob.com',
     name: username_3,
     subscription: 'both',
     order: 4,
     type: 'jid'
     }
     }
     jid, username, subscription均在获取好友列表时已获取到，用户可根据好友列表动态获取这些参数，
     order不重复即可
     */
    var addToBlackList = function () {
        var list = {
            // user_1
            asdfghj: {
                jid: "easemob-demo#chatdemoui_asdfghj@easemob.com",
                name: "asdfghj",
                subscription: 'both',
                order: 2,
                type: 'jid'
            },
            // user_2
            wjy6: {
                jid: "easemob-demo#chatdemoui_wjy6@easemob.com",
                name: "wjy6",
                subscription: 'both',
                order: 3,
                type: 'jid'
            }
        };
        conn.addToBlackList({
            list: list,
            type: 'jid',
            success: function () {
                console.log('Add friend to black list success');
            },
            error: function () {
                console.log('Add friend to black list error');
            }
        });
    }

    // 获取好友黑名单，调用这个函数会回调conn.listen里的onBlacklistUpdate函数，具体细节请参照test.js
    var getBlackList = function () {
        conn.getBlacklist();
    };

    // 将好友从黑名单拉出来
    var removeBlackList = function () {
        var list = {};
        conn.removeFromBlackList({
            list: list,
            type: 'jid',
            success: function () {
                console.log('Remove from black list success.');
            },
            error: function () {
                console.log('Remove from black list error.')
            }
        });
    };

    // 聊天室发送文本消息
    var sendRoomText = function () {
        // 退出聊天室
        var id = conn.getUniqueId();
        var msg = new WebIM.message('txt', id);
        var option = {
            msg: 'scarecrfow',                       // 消息内容
            to: '114715680632209992',               // 接收消息对象(本例为twy-room1聊天室)
            roomType: true,
            chatType: 'chatRoom',
            success: function () {
                console.log('send room text success');
            },
            fail: function () {
                console.log('failed');
            }
        };
        msg.set(option);
        msg.setGroup('groupchat');
        conn.send(msg.body);
    };
    // 加入聊天室
    var joinRoom = function () {
        // 加入聊天室
        conn.joinChatRoom({
            roomId: "114715680632209992"
        });
    };
    // 退出聊天室
    var quitRoom = function () {
        // 退出聊天室
        conn.quitChatRoom({
            roomId: "114715680632209992"
        });
    };
    // 列出所有聊天室，支持分页查询
    var listRooms = function () {
        var option = {
            apiUrl: 'https://a1.easemob.com',
            pagenum: 1,                                 // 页数
            pagesize: 20,                               // 每页个数
            success: function (list) {
                console.log(list);
            },
            error: function () {
                console.log('List chat room error');
            }
        };
        conn.getChatRooms(option);
    }

    // 群组发送文本消息
    var sendGroupText = function () {
        var id = conn.getUniqueId();
        var msg = new WebIM.message('txt', id);
        var option = {
            msg: 'scarecrfow',                       // 消息内容
            to: '1480567165764',                     // 接收消息对象(本例为Test聊天室)
            roomType: false,
            chatType: 'chatRoom',
            success: function () {
                console.log('send room text success');
            },
            fail: function () {
                console.log('failed');
            }
        };
        msg.set(option);
        msg.setGroup('groupchat');
        conn.send(msg.body);
    };
    // 建立一个群组
    var createGroup = function () {
        var option = {
            subject: 'groupName',                       // 群名称
            description: 'create a group test',         // 群简介
            members: ['wjy6', 'asdfghj'],               // 以数组的形式存储需要加群的好友ID
            optionsPublic: true,                        // 允许任何人加入
            optionsModerate: false,                     // 加入需审批
            optionsMembersOnly: false,                  // 不允许任何人主动加入
            optionsAllowInvites: false                  // 允许群人员邀请
        };
        conn.createGroup(option);
    }
    // 获取群组信息（应用场景：判断用户是否为该群管理员）
    var queryGroupInfo = function () {
        conn.queryRoomInfo({
            roomId: '1480747027186',
            // settings 表示入群的权限，具体值待定
            // members[0]里面包含群主信息，其结构为{affiliation: "owner", jid: appKey + "_" + username + "@easemob.com"}
            // jid中的username就是群主ID
            // fields的结构为：
            /*
             {
             affiliations: "2",                  // 意义待查
             description: "12311231313",         // 群简介
             maxusers: "200",                    // 群最大成员容量
             name: "123",                        // 群名称
             occupants: "2",                     // 意义待查
             owner: "easemob-demo#chatdemoui_mengyuanyuan"               // 群主jid
             }
             */
            success: function (settings, members, fields) {
                console.log('settings: ', settings);
                console.log('members: ', members);
                console.log('fields: ', fields);
            },
            error: function (e) {
                console.log('Error!', e);
            }
        });
    };
    // 成员主动离开群
    var leaveGroup = function () {
        var option = {
            to: 'asdfghj',
            roomId: '1480747027186',
            success: function () {
                console.log('You leave room succeed!');
            },
            error: function () {
                console.log('Leave room faild');
            }
        };
        conn.leaveGroupBySelf(option);
    };
    // 将成员踢出群(同将群成员拉入群黑名单)
    var addToGroupBlackList = function () {
        var option = {
            affiliation: "owner",                       // 写死
            roomId: "1480756943693",                    // 群组ID
            success: function () {
                console.log('add to black list succeed');
            },
            to: 'asdfghj'                               // 需要删除的成员ID
        };
        conn.addToGroupBlackList(option);
    };
    // 列出所有群组
    var listGroups = function () {
        var option = {
            success: function (rooms) {
                console.log(rooms);
            },
            error: function () {
                console.log('List chat rooms error');
            }
        };
        conn.listRooms(option);
    };
    // 修改群信息
    var changeGroupInfo = function () {
        var option = {
            roomId: '1480756943693',
            subject: 'ChangeTest',
            description: 'Change group information test',
            success: function () {
                console.log("Change Group Names Success!");
            }
        };
        conn.changeGroupSubject(option);
    };
    // 获取群组黑名单
    var getGroupBlackList = function () {
        var option = {
            roomId: '1480758709661',
            success: function (list) {
                console.log('Get group black list: ', list);
            },
            error: function () {
                console.log('Get group black list error.');
            }
        };
        conn.getGroupBlacklist(option);
    };
    // 解散一个群组
    var destroyGroup = function () {
        var option = {
            reason: 'Test Destroy Group',
            roomId: '1480840256052',
            success: function () {
                console.log('Destroy group success!');
            }
        };
        conn.destroyGroup(option);
    };
    // 加好友入群
    var addGroupMembers = function () {
        var option = {
            list: ['asdfghj', 'wjy6'],
            roomId: '1480841456167'
        };
        conn.addGroupMembers(option);
    };
    // 将好友从黑名单移除
    var removeFromGroupBlackList = function () {
        var option = {
            roomId: '1480841456167',
            to: 'wjy6',
            success: function () {
                console.log('Remove from black list success!');
            }
        };
        conn.removeGroupMemberFromBlacklist(option);
    };

    // 查询群组成员，此方法亦可查询聊天室成员
    // 查询出来的member的结构为{affiliation: 'member', jid: "easemob-demo#chatdemoui_wjy6@easemob.com"}
    // 注意，这里的jid格式，成员的用户名是chatdemoui_之后，@easemob.com之前的字符串，如本例的wjy6是用户名
    var queryRoomMember = function () {
        var member = '';
        conn.queryRoomMember({
            roomId: '114715680632209992',
            success: function (members) {
                for (var o in members) {
                    member = members[o];
                    console.log(member);
                }
            }
        });
    };

    /*
     * WebRTC
     */
    // 视频呼叫对方
    var call = function () {
        rtcCall.caller = 'wenke123';
        rtcCall.makeVideoCall('asdfghj');
    };
    // 关掉/拒绝视频
    var endCall = function () {
        rtcCall.endCall();
    }
    // 接受对方呼叫
    var acceptCall = function () {
        rtcCall.acceptCall();
    }

    // 语音呼叫对方
    var audioCall = function () {
        console.log('Audio Call');
        rtcCall.caller = 'wenke123';
        rtcCall.makeVoiceCall('asdfghj');
    };

    //
    var logout = function () {
//        conn.clear();
        conn.close('logout');
        conn.errorType = WebIM.statusCode.WEBIM_CONNCTION_CLIENT_LOGOUT;


    }

    var reConn = function () {
        //appkey： easemob-demo#vip5
        //xmppURL: 'im-api-vip5.easemob.com',
        //apiURL: (location.protocol === 'https:' ? 'https:' : 'http:') + '//a1-vip5.easemob.com',
        //账号：10vip5/123456 ,11vip5/123456
        options = {
            xmppURL: 'im-api-vip5.easemob.com',
            apiUrl: (location.protocol === 'https:' ? 'https:' : 'http:') + '//a1-vip5.easemob.com',
            appKey: "easemob-demo#vip5",
            user: "10vip5",
            pwd: "123456"
        };
        conn.open(options)

    };
</script>
<script>
    /**
     * Created by clock on 16-11-30.
     */
   /*  window.onload = function () { */
    	/* document.getElementById('privateText').onclick = sendPrivateText; */

        // 贴图发送（放到消息模块里）
        /* document.addEventListener('paste', function (e) {
            if (e.clipboardData && e.clipboardData.types) {
                if (e.clipboardData.items.length > 0) {
                    if (/^image\/\w+$/.test(e.clipboardData.items[0].type)) {
                        var blob = e.clipboardData.items[0].getAsFile();
                        var url = window.URL.createObjectURL(blob);
                        var id = conn.getUniqueId();//生成本地消息id

                        var msg = new WebIM.message('img', id);
                        msg.set({
                            apiUrl: WebIM.config.apiURL,
                            file: {data: blob, url: url},
                            to: 'asdfghj',
                            roomType: false,
                            chatType: 'singleChat',
                            onFileUploadError: function (error) {
                                console.log("Error");
                            },
                            onFileUploadComplete: function (data) {
                                console.log("Complete", data);
                            },
                            success: function (id) {
                                console.log("Success");
                            }
                        });
                        conn.send(msg.body);
                    }
                }
            }
        }); */

      options = {
            apiUrl: WebIM.config.apiURL,
            user:''+cookie.get("user1")+'',
            pwd:''+cookie.get("pwd1")+'',
            appKey: WebIM.config.appkey
        };
        conn.open(options);
        /* }; 
    conn.listen({
        onEmojiMessage: function (message) {
            // 当为WebIM添加了Emoji属性后，若发送的消息含WebIM.Emoji里特定的字符串，connection就会自动将
            // 这些字符串和其它文字按顺序组合成一个数组，每一个数组元素的结构为{type: 'emoji(或者txt)', data:''}
            // 当type='emoji'时，data表示表情图像的路径，当type='txt'时，data表示文本消息
            console.log('Emoji');
            var data = message.data;
            for(var i = 0 , l = data.length ; i < l ; i++){
                console.log(data[i]);
            }
        },   //收到表情消息
    }); */
    
</script>
<script>
   $(function(){
   	if(undefined != cookie.get("user1")){
	   	var user1 = cookie.get("user1");
	   	$("#disDiv").show();
	   	$("#inputValue").val(user1);
	   	document.getElementById('form').style.display='none';
	    document.getElementById(user1).style.display='none';
	    document.getElementById(user1+'S').style.display='none';
   	}
   })

</script>
<script>
	$("#logout").click(function(){
		var user1 = cookie.get("user1"); 
  		//cookie.delete(user1);
		 cookie.set("user1","",-1);
		 window.location='http://localhost:8080/chat.liaozi.net/';
	});
	
	function sendLook(){
		$("#pic_list").show();
	}
	
	/* $("#ulClass li").click(function(){
		var msg = $(this).attr("key");
		$("#msg").val(msg);
	}) */
	$("#ulClass li").click(function(){
		var msg = $(this).attr("key");
		var srcmsg=$(this).find('img').attr("src");
		var text="<img src="+srcmsg+">";
		//ar msg1=$("#realText").val()+text;
		var msg2=$("#msg").html()+text;
		//alert(msg2);
		$("#msg").html(msg2);
		//$("#realText").val(msg2);
		
		$("#pic_list").hide();
	})

	
</script>
</body>
</html>
